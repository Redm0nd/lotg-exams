name: Deploy Infrastructure and Application

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/lotg-exams-github-actions
  TF_VERSION: 1.6.0
  NODE_VERSION: 20
  TF_VAR_auth0_domain: ${{ secrets.AUTH0_DOMAIN }}
  TF_VAR_auth0_audience: ${{ secrets.AUTH0_AUDIENCE }}

jobs:
  # Detect which folders have changes
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - '.infra/**'
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Build backend early - Terraform needs zip files to exist for Lambda resources
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: changes
    # Build if infra or backend changed (infra needs zips for Lambda resources)
    if: needs.changes.outputs.infra == 'true' || needs.changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Lambda Functions
        run: npm run build

      - name: Upload Lambda Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-zips
          path: backend/dist/*.zip
          retention-days: 1

  # Terraform Plan - only runs if infra changed
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [changes, build-backend]
    if: needs.changes.outputs.infra == 'true'
    defaults:
      run:
        working-directory: .infra
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda Artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-zips
          path: backend/dist

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan -out=tfplan -detailed-exitcode -no-color 2>&1 | tee plan_output.txt
          exit_code=$?
          set -e

          # Exit code 0 = no changes, 1 = error, 2 = changes
          if [ "$exit_code" -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          elif [ "$exit_code" -eq 1 ]; then
            echo "Plan failed"
            cat plan_output.txt
            exit 1
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Show Plan in Summary
        if: always()
        run: |
          echo "## Terraform Plan Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```hcl' >> $GITHUB_STEP_SUMMARY
          cat plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan (binary)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: .infra/tfplan
          retention-days: 1

      - name: Upload Plan (readable)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: plan-output
          path: .infra/plan_output.txt
          retention-days: 1

  # Terraform Apply - requires approval, uses saved plan
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [changes, build-backend, terraform-plan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.changes.outputs.infra == 'true'
    environment: production
    defaults:
      run:
        working-directory: .infra
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda Artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-zips
          path: backend/dist

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .infra

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # Get Terraform outputs - runs after apply (if infra changed) or independently
  get-outputs:
    name: Get Terraform Outputs
    runs-on: ubuntu-latest
    needs: [changes, terraform-apply]
    # Run if: (infra changed AND apply succeeded) OR (infra didn't change but backend/frontend changed)
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      (needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true') &&
      (needs.terraform-apply.result == 'success' || needs.terraform-apply.result == 'skipped')
    defaults:
      run:
        working-directory: .infra
    outputs:
      api_url: ${{ steps.tf-output.outputs.api_url }}
      s3_bucket: ${{ steps.tf-output.outputs.s3_bucket }}
      cloudfront_id: ${{ steps.tf-output.outputs.cloudfront_id }}
      lambda_get_quizzes: ${{ steps.tf-output.outputs.lambda_get_quizzes }}
      lambda_get_quiz: ${{ steps.tf-output.outputs.lambda_get_quiz }}
      lambda_get_questions: ${{ steps.tf-output.outputs.lambda_get_questions }}
      lambda_submit_answers: ${{ steps.tf-output.outputs.lambda_submit_answers }}
      lambda_generate_presigned_url: ${{ steps.tf-output.outputs.lambda_generate_presigned_url }}
      lambda_process_pdf: ${{ steps.tf-output.outputs.lambda_process_pdf }}
      lambda_get_question_bank: ${{ steps.tf-output.outputs.lambda_get_question_bank }}
      lambda_review_question: ${{ steps.tf-output.outputs.lambda_review_question }}
      lambda_bulk_review_questions: ${{ steps.tf-output.outputs.lambda_bulk_review_questions }}
      lambda_get_extraction_jobs: ${{ steps.tf-output.outputs.lambda_get_extraction_jobs }}
      lambda_publish_quiz: ${{ steps.tf-output.outputs.lambda_publish_quiz }}
      lambda_create_manual_job: ${{ steps.tf-output.outputs.lambda_create_manual_job }}
      lambda_add_manual_question: ${{ steps.tf-output.outputs.lambda_add_manual_question }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Get Terraform Outputs
        id: tf-output
        run: |
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          echo "lambda_get_quizzes=$(terraform output -json lambda_function_names | jq -r '.get_quizzes')" >> $GITHUB_OUTPUT
          echo "lambda_get_quiz=$(terraform output -json lambda_function_names | jq -r '.get_quiz')" >> $GITHUB_OUTPUT
          echo "lambda_get_questions=$(terraform output -json lambda_function_names | jq -r '.get_questions')" >> $GITHUB_OUTPUT
          echo "lambda_submit_answers=$(terraform output -json lambda_function_names | jq -r '.submit_answers')" >> $GITHUB_OUTPUT
          echo "lambda_generate_presigned_url=$(terraform output -json lambda_function_names | jq -r '.generate_presigned_url')" >> $GITHUB_OUTPUT
          echo "lambda_process_pdf=$(terraform output -json lambda_function_names | jq -r '.process_pdf')" >> $GITHUB_OUTPUT
          echo "lambda_get_question_bank=$(terraform output -json lambda_function_names | jq -r '.get_question_bank')" >> $GITHUB_OUTPUT
          echo "lambda_review_question=$(terraform output -json lambda_function_names | jq -r '.review_question')" >> $GITHUB_OUTPUT
          echo "lambda_bulk_review_questions=$(terraform output -json lambda_function_names | jq -r '.bulk_review_questions')" >> $GITHUB_OUTPUT
          echo "lambda_get_extraction_jobs=$(terraform output -json lambda_function_names | jq -r '.get_extraction_jobs')" >> $GITHUB_OUTPUT
          echo "lambda_publish_quiz=$(terraform output -json lambda_function_names | jq -r '.publish_quiz')" >> $GITHUB_OUTPUT
          echo "lambda_create_manual_job=$(terraform output -json lambda_function_names | jq -r '.create_manual_job')" >> $GITHUB_OUTPUT
          echo "lambda_add_manual_question=$(terraform output -json lambda_function_names | jq -r '.add_manual_question')" >> $GITHUB_OUTPUT

  # Deploy Backend - uses pre-built artifacts
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [changes, build-backend, get-outputs]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.backend == 'true' &&
      needs.get-outputs.result == 'success'
    steps:
      - name: Download Lambda Artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-zips
          path: backend/dist

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda - getQuizzes
        if: needs.get-outputs.outputs.lambda_get_quizzes != '' && needs.get-outputs.outputs.lambda_get_quizzes != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_get_quizzes }} \
            --zip-file fileb://backend/dist/getQuizzes.zip

      - name: Update Lambda - getQuiz
        if: needs.get-outputs.outputs.lambda_get_quiz != '' && needs.get-outputs.outputs.lambda_get_quiz != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_get_quiz }} \
            --zip-file fileb://backend/dist/getQuiz.zip

      - name: Update Lambda - getQuestions
        if: needs.get-outputs.outputs.lambda_get_questions != '' && needs.get-outputs.outputs.lambda_get_questions != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_get_questions }} \
            --zip-file fileb://backend/dist/getQuestions.zip

      - name: Update Lambda - submitAnswers
        if: needs.get-outputs.outputs.lambda_submit_answers != '' && needs.get-outputs.outputs.lambda_submit_answers != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_submit_answers }} \
            --zip-file fileb://backend/dist/submitAnswers.zip

      - name: Update Lambda - generatePresignedUrl
        if: needs.get-outputs.outputs.lambda_generate_presigned_url != '' && needs.get-outputs.outputs.lambda_generate_presigned_url != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_generate_presigned_url }} \
            --zip-file fileb://backend/dist/generatePresignedUrl.zip

      - name: Update Lambda - processPdf
        if: needs.get-outputs.outputs.lambda_process_pdf != '' && needs.get-outputs.outputs.lambda_process_pdf != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_process_pdf }} \
            --zip-file fileb://backend/dist/processPdf.zip

      - name: Update Lambda - getQuestionBank
        if: needs.get-outputs.outputs.lambda_get_question_bank != '' && needs.get-outputs.outputs.lambda_get_question_bank != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_get_question_bank }} \
            --zip-file fileb://backend/dist/getQuestionBank.zip

      - name: Update Lambda - reviewQuestion
        if: needs.get-outputs.outputs.lambda_review_question != '' && needs.get-outputs.outputs.lambda_review_question != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_review_question }} \
            --zip-file fileb://backend/dist/reviewQuestion.zip

      - name: Update Lambda - bulkReviewQuestions
        if: needs.get-outputs.outputs.lambda_bulk_review_questions != '' && needs.get-outputs.outputs.lambda_bulk_review_questions != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_bulk_review_questions }} \
            --zip-file fileb://backend/dist/bulkReviewQuestions.zip

      - name: Update Lambda - getExtractionJobs
        if: needs.get-outputs.outputs.lambda_get_extraction_jobs != '' && needs.get-outputs.outputs.lambda_get_extraction_jobs != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_get_extraction_jobs }} \
            --zip-file fileb://backend/dist/getExtractionJobs.zip

      - name: Update Lambda - publishQuiz
        if: needs.get-outputs.outputs.lambda_publish_quiz != '' && needs.get-outputs.outputs.lambda_publish_quiz != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_publish_quiz }} \
            --zip-file fileb://backend/dist/publishQuiz.zip

      - name: Update Lambda - createManualJob
        if: needs.get-outputs.outputs.lambda_create_manual_job != '' && needs.get-outputs.outputs.lambda_create_manual_job != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_create_manual_job }} \
            --zip-file fileb://backend/dist/createManualJob.zip

      - name: Update Lambda - addManualQuestion
        if: needs.get-outputs.outputs.lambda_add_manual_question != '' && needs.get-outputs.outputs.lambda_add_manual_question != 'null'
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.get-outputs.outputs.lambda_add_manual_question }} \
            --zip-file fileb://backend/dist/addManualQuestion.zip

  # Build and Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [changes, get-outputs]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.frontend == 'true' &&
      needs.get-outputs.result == 'success'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        env:
          VITE_API_URL: ${{ needs.get-outputs.outputs.api_url }}
          VITE_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          VITE_AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
        run: npm run build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3
        run: |
          aws s3 sync dist/ s3://${{ needs.get-outputs.outputs.s3_bucket }} --delete

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.get-outputs.outputs.cloudfront_id }} \
            --paths "/*"

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [changes, get-outputs, deploy-backend, deploy-frontend]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.changes.outputs.infra }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- **API Gateway:** ${{ needs.get-outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
